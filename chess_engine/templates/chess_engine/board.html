{% load chess_engine_extras %}

<table>
    <tr>
        <td>
            <table border="1">
                {% include 'chess_engine/board_line.html' with game=game game_data=game_data line=board.grid.8 line_key=8 even='#ccc' odd='#999' %}
                {% include 'chess_engine/board_line.html' with game=game game_data=game_data line=board.grid.7 line_key=7 even='#999' odd='#ccc' %}
                {% include 'chess_engine/board_line.html' with game=game game_data=game_data line=board.grid.6 line_key=6 even='#ccc' odd='#999' %}
                {% include 'chess_engine/board_line.html' with game=game game_data=game_data line=board.grid.5 line_key=5 even='#999' odd='#ccc' %}
                {% include 'chess_engine/board_line.html' with game=game game_data=game_data line=board.grid.4 line_key=4 even='#ccc' odd='#999' %}
                {% include 'chess_engine/board_line.html' with game=game game_data=game_data line=board.grid.3 line_key=3 even='#999' odd='#ccc' %}
                {% include 'chess_engine/board_line.html' with game=game game_data=game_data line=board.grid.2 line_key=2 even='#ccc' odd='#999' %}
                {% include 'chess_engine/board_line.html' with game=game game_data=game_data line=board.grid.1 line_key=1 even='#999' odd='#ccc' %}
                <tr>
                    <td></td><td>a</td><td>b</td><td>c</td><td>d</td><td>e</td><td>f</td><td>g</td><td>h</td>
                </tr>
            </table>
        </td>
        <td>
            <div id="panel_log" style="overflow-y:auto; height: 620px;">
            <h4>Log</h4>
            <table border="1">
                <tr><td><b>Step</b></td>
                    <td><b>Offic.</b></td>
                    <td><b>Piece</b></td>
                    <td><b>Source</b></td>
                    <td><b>Target</b></td>
                    <td><b>Eat</b></td>
                </tr>
                {% for log_key, log in game_data.token.logs.items|dictsort:"0.lower" %}
                <tr>
                    <td>{{ log_key }}</td>
                    <td>{{ log.official }}</td>
                    <td>{{ log.source.piece.r }}</td>
                    <td>{{ log.source.x }}{{ log.source.y }}</td>
                    <td>{{ log.target.x }}{{ log.target.y }}</td>
                    <td>{{ log.target.piece.r }}</td>
                </tr>
                {% endfor %}
            </table>
            </div>
        </td>
        <td>
            <div id="panel_special_data" style="overflow-y:auto; height: 620px; width: 300px;">
                <h4>Debug</h4>
                En passant : {{ game_data.token.step.enpassant }}<br /><br />
                Castling :<ul>
                    <li>White : {{ game_data.token.step.castle.white }}</li>
                    <li>Black : {{ game_data.token.step.castle.black }}</li>
                </ul><br />
                Step : <button onclick="toggle_panel('debug_step');">Toggle</button><br/>
                <div id="debug_step">{{ game_data|render_realjson2html:'token/step'|safe }}</div>
                Rounds : <button onclick="toggle_panel('debug_rounds');">Toggle</button><br />
                <div id="debug_rounds">{{ game_data|render_realjson2html:'rounds'|safe }}</div>
                Board : <button onclick="toggle_panel('debug_board');">Toggle</button><br />
                <div id="debug_board" style="display: none">{{ game_data|render_realjson2html:'board'|safe }}</div>
                Logs : <button onclick="toggle_panel('debug_logs');">Toggle</button><br />
                <div id="debug_logs" style="display: none">{{ game_data|render_realjson2html:'token/logs'|safe }}</div>
            </div>
        </td>
    </tr>
    <tr>
        <td>
            Turn : {{ game_data.token.step.side }}
            <div id="panel_promotion" style="display: none;">
                <table border="1">
                    <tr>
                        <td>
                            <a id="{{ l_key }}_{{ c_key }}" href="{% url 'piece-promote' pk=game.id role_name='Q' %}">
                                <img src="/static/chess_engine/pieces/{{ game_data.token.step.side|slice:'0:1' }}_queen.png" />
                            </a>
                        </td>
                        <td>
                            <a id="{{ l_key }}_{{ c_key }}" href="{% url 'piece-promote' pk=game.id role_name='R' %}">
                                <img src="/static/chess_engine/pieces/{{ game_data.token.step.side|slice:'0:1' }}_rook.png" />
                            </a>
                        </td>
                        <td>
                            <a id="{{ l_key }}_{{ c_key }}" href="{% url 'piece-promote' pk=game.id role_name='B' %}">
                                <img src="/static/chess_engine/pieces/{{ game_data.token.step.side|slice:'0:1' }}_bishop.png" />
                            </a>
                        </td>
                        <td>
                            <a id="{{ l_key }}_{{ c_key }}" href="{% url 'piece-promote' pk=game.id role_name='H' %}">
                                <img src="/static/chess_engine/pieces/{{ game_data.token.step.side|slice:'0:1' }}_horse.png" />
                            </a>
                        </td>
                    </tr>
                </table>
            </div>
        </td>
    </tr>
    <tr>
        <td>
            <div id="panel_message">
                {% if game_data.token.step.data.impossible_move %}
                <span class="message">
                    <b>Impossible move !</b><br />
                    Reason : {{ game_data.token.step.data.impossible_move }}
                </span>
                {% endif %}
            </div>
        </td>
    </tr>
    {% if user_can_play %}
    <tr>
        <td>
            <div id="panel_buttons">
                <table border="1">
                    <tr>
                        <td>
                            <a id="button_surrender_checkmate" href="{% url 'menu-action' pk=game.id action='surrender_checkmate' value=game_data.token.step.side %}">Surrender (checkmate)</a>
                        </td>
                        {% if user_is_creator %}
                        <td>
                            <a id="button_reset_round" href="{% url 'menu-action' pk=game.id action='reset_round' value=game_data.token.step.side %}">Reset current round</a>
                        </td>
                        <td>
                            <a id="button_reset_game" href="{% url 'menu-action' pk=game.id action='reset_game' value=game_data.token.step.side %}">Reset game</a>
                        </td>
                        {% endif %}
                    </tr>
                </table>
            </div>
        </td>
    </tr>
    {% endif %}
</table>

<script>
    $(document).ready(function() {
        console.log('document ready');
        {% if game_data.token.step.name == 'promote' %}
            $('#panel_promotion').show();
        {% endif %}

    });

    function toggle_panel(div_to_toggle) {
        $('#' + div_to_toggle).toggle();
    }
</script>
